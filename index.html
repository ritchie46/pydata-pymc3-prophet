<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>reveal.js</title>

    <link rel="stylesheet" href="reveal.js/css/reset.css">
    <link rel="stylesheet" href="reveal.js/css/reveal.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="css/androidstudio.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <img src="img/xomnia_logo.svg" id="xomnia-logo">
    <div class="slides">
        <section>
            <h2># Facebook's Prophet in PyMC3</h2>
            <h4>Ritchie Vink</h4>
        </section>
        <section class="default-aspect-ratio">
            <h4>Humanly generated data</h4>
            <img src="img/business-data.png"/>
        </section>
        <section>
            <h4>Handling this data</h4>
            <p id="sarimax-wrap">
                <b class="sarimax">S</b>
                <small class="sarimax">seasonal</small>
                <br>
                <br>
                <b class="sarimax">A</b> <br>
                <b class="sarimax">R</b>
                <small class="sarimax sarimax-shift">auto-regressive</small>
                <br>
                <br>
                <b class="sarimax">I</b>
                <small class="sarimax">integrated</small>
                <br>
                <br>
                <b class="sarimax">M</b> <br>
                <b class="sarimax">A</b>
                <small class="sarimax sarimax-shift">moving average</small>
                <br>
                <br>
                <b class="sarimax">X</b>
                <small class="sarimax">exogenous</small>
            </p>
        </section>
        <section class="fill-parent">
            <img src="img/logo-prophet.png" class="logo-left-top" width="200px"/>
            <h4 class="lower-title">Generalized Additive Models</h4>
            <br>
            <br>
            <div>
                $$ y(t) = \underbrace{g(t)}_{\text{trend}} +
                \underbrace{s(t)}_\text{seasonality} +
                \underbrace{h(t)}_\text{holiday effects} + \epsilon_t $$
            </div>
        </section>
        <section class="fill-parent">
            <img src="img/PyMC3_banner.svg" class="logo-left-top" style="background: white;" width="200px"/>

            <h4 class="lower-title">Bayesian Curve Fitting w/ PYMC3</h4>
            <div>
                $$ \underbrace{P(\theta|D)}_\text{posterior} =
                \frac{ \overbrace{P(D|\theta)}^{\text{likelihood}} \cdot \overbrace{P(\theta)}^{\text{prior}} }
                { \underbrace{P(D)}_{\text{marginal likelihood}} }$$
            </div>
        </section>
        <section>
            <h4>Changepoints $g(t)$</h4>
            <img src="img/ts-changepoint.png">
        </section>
        <section>
            <h4>Changepoints breakdown</h4>

            <div>
                $$ g(t) = \underbrace{(k + a(t)^T \delta)t}_\text{trend} + \underbrace{(m + a(t)^T
                \gamma)}_\text{offset} $$
            </div>
            <ul>
                <li>$k _\text{ base trend}$</li>
                <li>$\delta _\text{ growth rate adjustments}$</li>
            </ul>
        </section>
        <section>
            <h4>Changepoints breakdown</h4>
            <br>
            <ul class="no-bullet math-font">
                <li>Changepoints in vector <span style="padding-left:6em">$S$</span></li>
                <li>Growth change adjustment vector <span style="padding-left:0.5em">$\delta \in \mathbb{R}^S$</span>
                </li>
            </ul>
            <br>
            <br>
            <div class="math-font">
                for every timestep $t$:
                <br>
                <br>
                $$ k + \sum_{j: t > s_j} \delta_j $$
                <div id="dot-product-note">dot product</div>
            </div>
        </section>
        <section>
            <h4>Changepoints breakdown: <i>vectorized</i></h4>
            <div class="row-flex">
                <div class="slide-vectorized-changepoints-item">
                    $$ a(t) \in \{0, 1\}^S$$
                </div>
                <div class="slide-vectorized-changepoints-item">
                    $$ a(t)=

                    \begin{cases}
                    1, & \text{if } t\geq s_j, \\
                    0, & \text{otherwise}
                    \end{cases}
                    $$
                </div>
            </div>
            <div>
                $$
                k + a(t)^T \delta
                $$
            </div>
        </section>
        <section>
            <h4>Changepoints breakdown: <i>vectorized</i></h4>
            <br>
            <div class="math-font">Rewrite the whole function $a(t)^T$ in a matrix $A$</div>
            <br>
            <div class="math-font" style="font-size: 20px">Example: Let $S$ be $2, 5, 8$ and let $t$ be $1, 2, \dots, 10$</div>
            <div style="font-size: 20px">
                $$
                 A =
 \begin{bmatrix}
     t_{1} \geq s_1  & t_{1} \geq s_2  & \dots  & t_{1} \geq s_n \\
     t_{2} \geq s_1  & t_{2} \geq s_2  & \dots  & t_{2} \geq s_n \\
     \vdots       & \vdots       & \ddots & \vdots      \\
     t_{k} \geq s1  & t_{k} \geq s_2 & \dots  & t_{k} \geq s_n
 \end{bmatrix}
 =

  \begin{bmatrix}
      1 \geq 2     & 1 \geq 5  & 1 \geq 8 \\
      2 \geq 2     & 2 \geq 5  & 2 \geq 8 \\
      \vdots       & \vdots    & \vdots   \\
      10 \geq 2    & 10 \geq 5 & 10 \geq 8
  \end{bmatrix}

 =

  \begin{bmatrix}
      0       &  0        & 0 \\
      1       &  0        & 0 \\
   \vdots  & \vdots    & \vdots   \\
      1       &  1        & 1
  \end{bmatrix}
$$
            </div>

        </section>
        <section >
            <h4>Changepoints breakdown: <i style="text-transform: none">numpy</i></h4>
            <div class="row-flex" style="width: 100%">
                <div >
            	    <pre style="width: 100%;">
                        <code class="python" style="overflow: hidden;">
np.random.seed(25)
n_changepoints = 10
t = np.arange(1000)
s = np.sort(np.random.choice(t, n_changepoints, replace=False))

A = (t[:, None] > s) * 1
delta = np.random.normal(size=n_changepoints)
k = 1
m = 5

growth = (k + np.dot(A, delta)) * t
gamma = -s * delta
offset = m + np.dot(A, gamma)
trend = growth + offset

                        </code>
                    </pre>
                </div>
                <div>
                    <img src="img/piecewise-trend.png" style="height: 250px; width: 700px;
                    position: relative; top: 20px; margin-left: 40px">
                </div>
            </div>
        </section>
        <section>
            <h4>Changepoints breakdown: <i style="text-transform: none">PyMC3</i></h4>
            <div class="row-flex">
                <div style="font-size: 20px">
                    $$ k \sim N(0, 5) $$
                    $$ \delta \sim Laplace(0, 0.05) $$
                    $$ m \sim N(0, 5) $$
                    $$ g|k, \delta, m = (k + A \delta) \odot t + (m + A (-s \odot \delta)) $$
                    $$ \sigma \sim N(0, 0.5) $$
                    $$ y| g, \sigma \sim N(g, \sigma) $$
                </div>
                <div>
                        <pre style="width: 100%; margin-left: 20px">
                        <code class="python" style="overflow: hidden;">
# * 1 casts the boolean to integers
A = (t[:, None] > s) * 1

with pm.Model():
    # initial growth
    k = pm.Normal('k', 0 , 5)

    # rate of change
    delta = pm.Laplace('delta', 0, 0.05, shape=n_changepoints)
    # offset
    m = pm.Normal('m', 0, 5)
    gamma = -s * delta

    g = (k + tt.dot(A, delta)) * t + (m + tt.dot(A, gamma))
    sigma = pm.HalfCauchy('sigma', 0.5)
    observed =  pm.Normal('obs', mu=g, sd=sigma, observed=df['y_scaled'])

                        </code>
                    </pre>
                </div>
            </div>
        </section>
        <section>
            <img src="img/g_t.png" style="background: white">
        </section>
        <section>
            <h3>How is this forecasting?</h3>
        </section>
        <section data-background-image="img/seasons.jpg">
            <h1 id="seasonality-banner">Seasonality</h1>
        </section>
        <section>
            <h4>Fourier series</h4>
            <div>
                $$ s(t) = \sum_{n=1}^N(a_n cos(\frac{2\pi nt}{P}) + b_n sin(\frac{2 \pi nt}{P})) $$
            </div>
            <div class="math-font row-flex">
                <div style="font-size: 32px; width: 40%; height: 200px;" class="border-me">
                    $$ \beta \in \mathbb{R}^{2N}$$
                    $$\beta = a_1, b_1, ..., a_n, b_n $$
                </div>

                <div style=" width: 40%; height: 200px; margin-left: 20px" class="border-me">
                <table style="font-size: 35px">
                    <tr>
                        <th></th>
                        <td>weekly<br></td>
                        <td>yearly<br></td>
                    </tr>
                    <tr>
                        <td>N</td>
                        <td>3</td>
                        <td>10</td>
                    </tr>
                    <tr>
                        <td>P</td>
                        <td>365.25</td>
                        <td>7</td>
                    </tr>
                </table>
                </div>
            </div>
        </section>
        <section>
            <h4>Fourier series</h4>
            <div>
                $$ X(t) = [cos( \frac{2\pi 1t}{7}), \dots, sin(\frac{2\pi nt}{7})] $$
                $$ s(t) = X(t) \beta $$
            </div>
            <div class="math-font" style="font-size: 20px; position: relative; left: 350px; top: 150px;">
                <p>$\text{rows}: t$</p>
                <p>$\text{columns}: 2N$</p>
            </div>
        </section>
        <section>
            <h4>Fourier series</h4>
            <div class="row-flex">
            <pre style="width: 45%;">
                <code class="python">
np.random.seed(6)
def fourier_series(t, p, n):
    # 2 pi n / p
    x = 2 * np.pi * np.arange(1, n + 1) / p
    # 2 pi n / p * t
    x = x * t[:, None]
    x = np.concatenate((np.cos(x), np.sin(x)), axis=1)
    return x

n = 10
t = np.arange(1000)
beta = np.random.normal(size=2 * n)
np.dot(fourier_series(t, 365.25, n), beta)
                </code>
            </pre>
                <img src="img/fourier.png" class="matplotlib" style="margin-left: 20px; margin-top: 35px; height: 230px">
            </div>
        </section>
        <section>
            <h4>Fourier series (helper function)</h4>
            <pre>
                <code class="python">
def seasonality_model(m, df, period='yearly', seasonality_prior_scale=10):
    if period == 'yearly':
        n = 10
        # rescale the period, as t is also scaled
        p = 365.25 / (df['ds'].max() - df['ds'].min()).days
    else:  # weekly
        n = 3
        # rescale the period, as t is also scaled
        p = 7 / (df['ds'].max() - df['ds'].min()).days
    x = fourier_series(df['t'], p, n)
    with m:
        beta = pm.Normal(f'beta_{period}', mu=0, sd=seasonality_prior_scale, shape=2 * n)
    return x, beta
                </code>
            </pre>
        </section>
        <section>
            <h4>Complete model (w/o holiday effects)</h4>
            <div style="font-size: 25px">
                $$y(t) = g(t) + s(t)_\text{weekly} + s(t)_\text{yearly} + \epsilon_t $$
            </div>
            <div class="row-flex">
                <div style="font-size: 25px">
                    $$ \beta \sim N(0, 10) $$
                    $$ s|\beta = X(t)\beta $$
                    $$ \sigma \sim HalfCauchy(0, 0.5) $$
                    $$ y|g, s, \sigma \sim N(g + s, \sigma) $$
                </div>

                <pre style="width: 60%;">
                    <code class="python">
with pm.Model() as m:
    # changepoints_prior_scale is None, so the exponential distribution
    # will be used as prior on \tau.
    y, A, s = trend_model(m, df['t'], changepoints_prior_scale=None)
    x_yearly, beta_yearly = seasonality_model(m, df, 'yearly')
    x_weekly, beta_weekly = seasonality_model(m, df, 'weekly')

    y += det_dot(x_yearly, beta_yearly) + det_dot(x_weekly, beta_weekly)

    sigma = pm.HalfCauchy('sigma', 0.5, testval=1)
    obs = pm.Normal('obs',
                 mu=y,
                 sd=sigma,
                 observed=df['y_scaled'])
                    </code>
                </pre>

            </div>
        </section>
        <section>
            <h4>Results (after a coffee break)</h4>

            <img src="img/fit.png" style="height: 590px;">
        </section>
        <section>
            <h4>Trend forecast & uncertainty</h4>
            <br>
            <div style="font-size: 30px">
                $$
                    \forall j > T,
                    \begin{cases}
                        \delta_j = 0 \quad w.p. \frac{T - S}{T} \\
                        \delta_j \sim Laplace(0, \lambda) \quad w.p. \frac{S}{T}
                    \end{cases}
                $$
            </div>
        </section>
        <section>
            <h4>Trend forecast & uncertainty</h4>
            <img src="img/forecast.png" class="matplotlib">
        </section>
        <section>
            <h4>Last words</h4>
            <br>
            <ul class="math-font" style="font-size: 30px">
                <li>Additional effects can be added (holidays, temperature, precipitation)</li>
                <li>Ability to regularize because of priors</li>
                <li>Q&A</li>
            </ul>
        </section>
    </div>
</div>
    <script src="reveal.js/js/reveal.js"></script>

    <script>
        // More info about config & dependencies:
        // - https://github.com/hakimel/reveal.js#configuration
        // - https://github.com/hakimel/reveal.js#dependencies
        Reveal.initialize({
            dependencies: [
                {src: 'reveal.js/plugin/markdown/marked.js'},
                {src: 'reveal.js/plugin/markdown/markdown.js'},
                {src: 'reveal.js/plugin/notes/notes.js', async: true},
                {src: 'reveal.js/plugin/highlight/highlight.js', async: true}
            ]
        });

    </script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']],
                skipTags: [ 'script', 'noscript', 'style', 'textarea', 'pre' ]},
    });


    </script>
    <script type="text/javascript" async src="MathJax-master/MathJax.js?config=TeX-AMS_HTML-full"></script>
</body>
</html>
